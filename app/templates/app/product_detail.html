{% extends 'app/base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block main-content %}
<div class="container my-5">

  <div class="row g-4">
  <!-- ·∫¢nh s·∫£n ph·∫©m -->
  <div class="col-md-6">
    <div class="shadow-sm rounded-4 overflow-hidden mb-3 text-center product-image-wrapper">
      {% if product.get_all_images %}
        <img id="mainImage" src="{{ product.get_all_images.0 }}" 
             class="w-100 product-detail-img" 
             alt="{{ product.name }}">
      {% else %}
        <img id="mainImage" src="{% static 'app/images/placeholder.png' %}" 
             class="w-100 product-detail-img" 
             alt="{{ product.name }}">
      {% endif %}
    </div>
  </div>

  <!-- Th√¥ng tin s·∫£n ph·∫©m -->
  <div class="col-md-6 d-flex flex-column justify-content-center product-info-wrapper">
    <h2 class="fw-bold mb-2">{{ product.name }}</h2>
    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="badge bg-success">M·ªõi</span>
      <p class="text-muted mb-0"><i class="bi bi-geo-alt"></i> {{ product.location|default:"Kh√¥ng c√≥ ƒë·ªãa ch·ªâ" }}</p>
    </div>

    {% if product.discount_percent > 0 %}
      <h3 class="fw-semibold mb-3">
        <span class="text-success">{{ product.gia_giam|currency_vn }}</span>
        <del class="text-muted small ms-2"> {{ product.price|currency_vn }}</del>
        <span class="badge bg-danger ms-2">-{{ product.discount_percent }}%</span>
      </h3>
    {% else %}
      <h3 class="text-success fw-semibold mb-3">{{ product.price|currency_vn }}</h3>
    {% endif %}

    <div class="d-flex flex-wrap gap-2 mb-4">
      <button class="btn btn-outline-success btn-lg rounded-pill btn-add" 
              data-product="{{ product.id }}" 
              data-action="add">
        üõí Th√™m v√†o gi·ªè h√†ng
      </button>
      <a href="{% url 'product' %}" class="btn btn-secondary btn-lg rounded-pill">‚¨Ö Quay l·∫°i</a>
    </div>
  </div>
</div>
      

<!-- Thumbnail & Video -->
<div class="row mt-3">
  <div class="col-md-6 d-flex gap-2 flex-wrap justify-content-center align-items-center">
    {% for img in product.get_all_images %}
      {% if img %}
        <img src="{{ img }}" 
             class="thumb-img {% if forloop.first %}active{% endif %}" 
             alt="thumb-{{ forloop.counter }}">
      {% endif %}
    {% endfor %}

    {% for v in product.videos.all %}
      {% if v.video_url %}
      <video muted 
             class="thumb-img thumb-video-preview" 
             onclick="showVideo('{{ v.video_url }}')">
        <source src="{{ v.video_url }}" type="video/mp4">
      </video>
      {% endif %}
    {% endfor %}
  </div>
</div>
    

  <hr class="my-5">

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="productTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button">üìñ M√¥ t·∫£</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button">‚ÑπÔ∏è Chi ti·∫øt</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button">‚≠ê B√¨nh lu·∫≠n</button>
    </li>
  </ul>

  <div class="tab-content border border-top-0 rounded-bottom p-4 bg-light dark-bg" id="productTabContent">

    <!-- M√¥ t·∫£ -->
    <div class="tab-pane fade show active" id="desc">
      {% if product.description %}
        <p>{{ product.description }}</p>
      {% else %}
        <p class="text-muted">S·∫£n ph·∫©m ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt.</p>
      {% endif %}
    </div>

   <!-- Chi ti·∫øt -->
<div class="tab-pane fade" id="detail">
  <ul class="list-unstyled">
    <li><strong>T√™n:</strong> {{ product.name }}</li>
    <li><strong>Gi√°:</strong> 
  {% if product.discount_percent > 0 %}
    <span class="text-success">{{ product.gia_giam|currency_vn }}</span>
    <del class="text-muted small ms-2">{{ product.price|currency_vn }}</del>
  {% else %}
    {{ product.price|currency_vn }}
  {% endif %}
</li>

    <li><strong>ƒê·ªãa ch·ªâ:</strong> {{ product.location|default:"Kh√¥ng c√≥ ƒë·ªãa ch·ªâ" }}</li>
    <li><strong>Qu·∫≠n:</strong>
      {% if product.district %}
        {{ product.get_district_display }}
      {% else %}
        Kh√¥ng r√µ
      {% endif %}
    </li>
    <li><strong>ID s·∫£n ph·∫©m:</strong> #{{ product.id }}</li>
    <li><strong>Lo·∫°i:</strong> {{ product.get_category_display }}</li>

    {% if product.size %}
      <li><strong>Di·ªán t√≠ch:</strong> {{ product.size }}</li>
    {% endif %}
  </ul>
</div>


    <!-- B√¨nh lu·∫≠n -->
    <div class="tab-pane fade" id="review">
      <h6 class="fw-bold mb-3">B√¨nh lu·∫≠n</h6>

      <div id="comment-list" class="mb-4">
        {% for c in product.comments.all %}
          <div class="border rounded p-3 mb-2">
            {% if c.name %}
              <strong>{{ c.name }}</strong>
            {% elif c.user %}
              <strong>{{ c.user.name }}</strong>
            {% else %}
              <strong>Kh√°ch</strong>
            {% endif %}
            <span class="text-muted small">{{ c.created_at|naturaltime }}</span>
            <p class="mb-0">{{ c.content }}</p>
          </div>
        {% empty %}
          <p class="text-muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n!</p>
        {% endfor %}
      </div>

      {% if request.user.is_authenticated %}
      <form id="comment-form">
        {% csrf_token %}
        <div class="mb-2">
          <textarea id="comment-content" class="form-control" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-success btn-sm rounded-pill">G·ª≠i b√¨nh lu·∫≠n</button>
      </form>
      {% else %}
      <p class="text-muted">B·∫°n c·∫ßn <a href="{% url 'login' %}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
      {% endif %}
    </div>

  </div>

  <!-- S·∫£n ph·∫©m li√™n quan -->
<div class="mt-5">
  <h5 class="fw-bold mb-3">S·∫£n ph·∫©m li√™n quan</h5>
  <div class="row g-3">
    {% for p in products %}
      {% if p.id != product.id %}
      <div class="col-6 col-md-3">
        <a href="{% url 'product_detail' p.id %}" class="text-decoration-none">
          <div class="card h-100 shadow-sm product-card-elegant border-0 rounded-4 overflow-hidden">
            
            {% if p.image_url %}
              <img src="{{ p.image_url }}" class="card-img-top product-img-elegant" alt="{{ p.name }}">
            {% else %}
              <img src="{% static 'app/images/placeholder.png' %}" class="card-img-top product-img-elegant" alt="{{ p.name }}">
            {% endif %}
            
            <div class="card-body text-center">
              <h6 class="mb-2 fw-semibold">{{ p.name|truncatechars:40 }}</h6>
              
              {% if p.discount_percent > 0 %}
                <p class="mb-0 fw-bold text-success">{{ p.gia_giam|currency_vn }}</p>
                <small class="text-muted text-decoration-line-through">{{ p.price|currency_vn }}</small>
                <span class="badge bg-danger ms-1">-{{ p.discount_percent }}%</span>
              {% else %}
                <p class="fw-bold text-success mb-0">{{ p.price|currency_vn }}</p>
              {% endif %}
            </div>
          </div>
        </a>
      </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

<style>
  .product-detail-img { max-height: 500px; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in; }
  .product-detail-img.zoomed { transform: scale(1.1); }
  .thumb-img { width: 70px; height: 70px; object-fit: cover; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all .3s ease; }
  .thumb-img:hover { border-color: #198754; transform: scale(1.05); }
  .thumb-img.active { border-color: #198754; }
  .btn-add { transition: all 0.3s ease; }
  .btn-add.added { background-color: #198754 !important; color: #fff !important; }
  body.dark .dark-bg { background-color: #2a2a2a !important; color: #eee !important; }
  body.dark .card { background-color: #2a2a2a; color: #eee; }
  body.dark .btn-secondary { background-color: #444; border-color: #444; }
  body.dark .nav-tabs .nav-link.active { background-color: #198754; color: #fff; }
  .product-image-wrapper, .product-info-wrapper { cursor: default; }
  .product-card-elegant {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    background-color: #fff;
  }
  .product-card-elegant:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }
  .product-img-elegant {
    height: 180px;
    object-fit: cover;
  }
  .product-card-elegant .text-success {
    color: #0f5132 !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrftoken = '{{ csrf_token }}';
  const mainImg = document.getElementById("mainImage");

  document.querySelectorAll(".thumb-img").forEach(img => {
    img.addEventListener("click", e => {
      e.preventDefault();
      e.stopPropagation();
      mainImg.src = img.src;
      document.querySelectorAll(".thumb-img").forEach(i => i.classList.remove("active"));
      img.classList.add("active");
    });
  });

  let zoomTimeout = null;
  mainImg.addEventListener("click", e => {
    e.preventDefault();
    e.stopPropagation();
    mainImg.classList.add("zoomed");
    clearTimeout(zoomTimeout);
    zoomTimeout = setTimeout(() => mainImg.classList.remove("zoomed"), 300);
  });
});

function showVideo(videoUrl){
  const wrapper = document.querySelector(".product-image-wrapper");
  wrapper.innerHTML = `
    <video controls autoplay class="w-100 product-detail-img rounded-4">
      <source src="${videoUrl}" type="video/mp4">
      Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
    </video>
  `;
}
</script>
{% endblock main-content %}
